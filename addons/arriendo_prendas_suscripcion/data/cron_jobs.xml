<?xml version="1.0" encoding="UTF-8"?>
<odoo>

    <record id="ir_cron_reset_monthly_subscription_changes" model="ir.cron">
        <field name="name">Resetear Cambios Mensuales de Suscripciones</field>
        <!-- Referencia al modelo sale.order. Asegúrate de que el ref sea correcto. -->
        <field name="model_id" ref="sale_subscription.model_sale_subscription"/>
        <field name="state">code</field>
        <!-- El código que se ejecutará. Llama al método que definiste en sale.order. -->
        <field name="code">model.action_reset_monthly_changes()</field>
        <!-- El usuario bajo el cual se ejecutará la tarea. user_root tiene todos los permisos. -->
        <field name="user_id" ref="base.user_root"/>
        <!-- Intervalo: Cada 1 mes. -->
        <field name="interval_number">1</field>
        <field name="interval_type">months</field>
        <!-- numbercall: -1 significa que se ejecutará indefinidamente. -->
        <field name="numbercall">-1</field>
        <!-- doall: False significa que no se ejecutará para todos los registros del modelo,
             sino que el método `action_reset_monthly_changes` se encargará de buscar los registros relevantes.
             Esto es correcto ya que tu método `action_reset_monthly_changes` ya hace un `self.search`. -->
        <field name="doall" eval="False"/>
        <!-- nextcall: La fecha y hora de la próxima ejecución.
             Es importante que sea una fecha y hora futura.
             Se calcula el primer día del mes actual a las 03:00:00 AM y se asegura que sea en el futuro.
             Si la fecha actual es después del primer día del mes, se debería calcular para el próximo mes.
             Odoo ajustará esto automáticamente al instalar el módulo si la fecha es pasada.
             Sin embargo, es más robusto calcularlo para el inicio del próximo mes si ya pasó el día 1 del actual.
             
             Una forma más robusta de calcular `nextcall` para asegurar que siempre sea el primer día del próximo mes
             después de la instalación o actualización del módulo:
             (datetime.datetime.now() + relativedelta(months=1)).replace(day=1, hour=3, minute=0, second=0).strftime('%Y-%m-%d %H:%M:%S')
             
             O bien, puedes dejarlo como está, y Odoo lo ajustará a la próxima fecha válida si la inicial es pasada.
             Para Odoo 18, `nextcall` puede ser una fecha fija o una expresión Python.
             Tu expresión es válida, pero asegúrate de que `datetime` esté disponible en el contexto de evaluación (lo está).
             -->
        <field name="nextcall" eval="(datetime.datetime.now().replace(day=1, hour=3, minute=0, second=0) + relativedelta(months=1)).strftime('%Y-%m-%d %H:%M:%S')"/>
        <!-- active: True para que la tarea esté activa al instalar el módulo. -->
        <field name="active" eval="True"/>
    </record>

</odoo>
